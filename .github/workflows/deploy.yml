name: Build-Push-Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  GCP_PROJECT: ${{ secrets.GCP_PROJECT_ID }}
  REGISTRY: gcr.io/${{ secrets.GCP_PROJECT_ID }}

jobs:
  build-and-validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Command Poller Image
        run: |
          echo "Building Command Poller agent..."
          docker build -f Dockerfile.poller -t agentkit-command-poller:${{ github.sha }} .
          docker tag agentkit-command-poller:${{ github.sha }} agentkit-command-poller:latest
          echo "‚úÖ Command Poller build successful"

      - name: Build Content Distribution Image
        run: |
          echo "Building Content Distribution agent..."
          docker build -f Dockerfile.distributor -t agentkit-content-distribution:${{ github.sha }} .
          docker tag agentkit-content-distribution:${{ github.sha }} agentkit-content-distribution:latest
          echo "‚úÖ Content Distribution build successful"

      - name: Build Site Scanner Image
        run: |
          echo "Building Site Scanner agent..."
          docker build -f Dockerfile.scanner -t agentkit-site-scanner:${{ github.sha }} .
          docker tag agentkit-site-scanner:${{ github.sha }} agentkit-site-scanner:latest
          echo "‚úÖ Site Scanner build successful"

      - name: Build Report Generator Image
        run: |
          echo "Building Report Generator agent..."
          docker build -f Dockerfile.reports -t agentkit-report-generator:${{ github.sha }} .
          docker tag agentkit-report-generator:${{ github.sha }} agentkit-report-generator:latest
          echo "‚úÖ Report Generator build successful"

      - name: Validate Docker Images
        run: |
          echo "Validating all Docker images..."
          docker images | grep agentkit
          echo ""

      - name: Build Summary
        run: |
          echo "================================================"
          echo "================================================"
          echo ""
          echo "üì¶ Images built:"
          echo "  ‚Ä¢ Command Poller"
          echo "  ‚Ä¢ Content Distribution"
          echo "  ‚Ä¢ Site Scanner"
          echo "  ‚Ä¢ Report Generator"
          echo ""
          echo "‚ÑπÔ∏è  Note: GCP deployment is disabled."
          echo "   To enable, configure GCP secrets and add deploy-to-gcp job."
          echo ""

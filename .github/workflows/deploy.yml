name: Build â†’ Deploy (multi-agent)

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  PROJECT_ID:  YOUR_GCP_PROJECT_ID      # <--- change
  REGION:      YOUR_GCP_REGION          # <--- change  e.g. us-central1
  AR_REPO:     YOUR_AR_REPO              # <--- change  e.g. agentkit-repo
  POOL_ID:     github-pool
  PROVIDER_ID: github-provider
  DEPLOYER_SA: github-deployer@${{ vars.PROJECT_ID }}.iam.gserviceaccount.com
  RUNTIME_SA:  cloud-run-runtime@${{ vars.PROJECT_ID }}.iam.gserviceaccount.com

permissions:
  id-token: write
  contents: read

jobs:
  build-validate-deploy:
    runs-on: ubuntu-latest
    environment: production        # add reviewers in GH UI if you want
    strategy:
      fail-fast: false
      matrix:
        agent:
          - agentkit-command-poller
          - agentkit-content-distribution
          - agentkit-site-scanner
          - agentkit-report-generator
    steps:
      - uses: actions/checkout@v4

      # ---- 1.  WIF auth (no JSON key) ----
      - id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/${{ vars.PROJECT_NUMBER }}/locations/global/workloadIdentityPools/${{ vars.POOL_ID }}/providers/${{ vars.PROVIDER_ID }}
          service_account: ${{ vars.DEPLOYER_SA }}

      # ---- 2.  gcloud & docker ----
      - uses: google-github-actions/setup-gcloud@v2
      - run: gcloud auth configure-docker ${{ vars.REGION }}-docker.pkg.dev

      # ---- 3.  build (re-use your exact Dockerfile) ----
      - name: Build ${{ matrix.agent }}
        run: |
          docker build -t ${{ vars.REGION }}-docker.pkg.dev/${{ vars.PROJECT_ID }}/${{ vars.AR_REPO }}/${{ matrix.agent }}:${{ github.sha }} \
                       -f agents/${{ matrix.agent }}/Dockerfile agents/${{ matrix.agent }}
          docker tag ${{ vars.REGION }}-docker.pkg.dev/${{ vars.PROJECT_ID }}/${{ vars.AR_REPO }}/${{ matrix.agent }}:${{ github.sha }} \
                     ${{ vars.REGION }}-docker.pkg.dev/${{ vars.PROJECT_ID }}/${{ vars.AR_REPO }}/${{ matrix.agent }}:latest

      # ---- 4.  push to Artifact Registry ----
      - run: docker push --all-tags ${{ vars.REGION }}-docker.pkg.dev/${{ vars.PROJECT_ID }}/${{ vars.AR_REPO }}/${{ matrix.agent }}

      # ---- 5.  deploy to Cloud Run ----
      - id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ matrix.agent }}
          image: ${{ vars.REGION }}-docker.pkg.dev/${{ vars.PROJECT_ID }}/${{ vars.AR_REPO }}/${{ matrix.agent }}:${{ github.sha }}
          region: ${{ vars.REGION }}
          project_id: ${{ vars.PROJECT_ID }}
          flags: |
            --service-account=${{ vars.RUNTIME_SA }}
            --no-allow-unauthenticated
            --execution-environment=gen2
            --cpu=1 --memory=512Mi
            --min-instances=1 --max-instances=10
            --concurrency=1 --timeout=300s
            --set-env-vars=AGENT_NAME=${{ matrix.agent }}

      - name: Show URL
        run: echo "${{ matrix.agent }} deployed to ${{ steps.deploy.outputs.url }}"
